
services:
  nextcloud-db:
    image: {{ nextcloud_db_image }}
    container_name: nextcloud-db
    restart: unless-stopped
    volumes:
      - nextcloud_db_data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      POSTGRES_DB: {{ nextcloud_db_name }}
      POSTGRES_USER: {{ nextcloud_db_user }}
      POSTGRES_PASSWORD: {{ vault_nextcloud_db_password }}
    networks:
      {{ traefik_network_name }}:
        ipv4_address: {{ nextcloud_db_container_ip }}

  nextcloud-redis:
    image: {{ nextcloud_redis_image }}
    container_name: nextcloud-redis
    restart: unless-stopped
    volumes:
      - nextcloud_redis_data:/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      {{ traefik_network_name }}:
        ipv4_address: {{ nextcloud_redis_container_ip }}

  nextcloud:
    image: {{ nextcloud_image }}
    container_name: nextcloud
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 8.8.8.8
      - {{ tailscale_ip }}
    volumes:
      - nextcloud_data:/var/www/html
      - {{ nextcloud_docker_dir }}/data:/var/www/html/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      POSTGRES_HOST: nextcloud-db
      POSTGRES_DB: {{ nextcloud_db_name }}
      POSTGRES_USER: {{ nextcloud_db_user }}
      POSTGRES_PASSWORD: {{ vault_nextcloud_db_password }}
      REDIS_HOST: nextcloud-redis
      NEXTCLOUD_TRUSTED_DOMAINS: {{ nextcloud_domain }}
      TRUSTED_PROXIES: 172.25.0.0/16
      OVERWRITEPROTOCOL: https
      OVERWRITEHOST: {{ nextcloud_domain }}
    networks:
      {{ traefik_network_name }}:
        ipv4_address: {{ nextcloud_container_ip }}
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`{{ nextcloud_domain }}`)"
      - "traefik.http.routers.nextcloud.entrypoints=https"
      - "traefik.http.routers.nextcloud.tls.certresolver=cloudflare"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
      - "traefik.http.middlewares.nextcloud-redirect.redirectregex.regex=https://(.*)/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud-redirect.redirectregex.replacement=https://$$1/remote.php/dav/"
      - "traefik.http.routers.nextcloud.middlewares=nextcloud-redirect"

volumes:
  nextcloud_data:
    name: nextcloud_data
  nextcloud_db_data:
    name: nextcloud_db_data
  nextcloud_redis_data:
    name: nextcloud_redis_data

networks:
  {{ traefik_network_name }}:
    external: true
